<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="../insighttree.css" />

<input class="sales-slider" type="range" min="0" max="30" value="5" />
<div class="sales-tree"></div>

<script type="module" class="script-source">
  import { insightTree, format } from "../index.js";
  import { csvParse } from "https://cdn.skypack.dev/d3-dsv@3";
  import { scaleLinear } from "https://cdn.skypack.dev/d3-scale@4";

  const color = scaleLinear().domain([-0.5, 0, 0.2]).range(["red", "yellow", "lime"]);

  const response = await fetch("../app/sales-data.csv");
  const data = csvParse(await response.text());
  const tree = insightTree({
    selector: ".sales-tree",
    data: data,
    groups: ["city", "product", "channel"],
    metrics: ["sales", "target"],
    rankBy: ({ sales, target }) => sales - target,
    render: (el, tree) => el.innerHTML = /* html */ `
      <table class="table table-sm w-auto">
        <thead>
          <tr><th></th><th>Group</th><th>Gap</th><th>%</th><th>Sales</th><th>Target</th></tr>
        </thead>
        <tbody>
          ${tree.map(({ _level, _rank, _group, sales, target }) => /* html */ `
            <tr data-insight-level="${_level}" data-insight-rank="${_rank}">
              <td class="text-end">#${_rank}</th>
              <td style="padding-left:${_level * 1.5}rem">
                <span class="insight-toggle"></span> ${_group}
              </td>
              <td class="text-end">${format.num(sales - target)}</td>
              <td class="text-end" style="background-color:${color(sales / target - 1)}">
                ${format.pc(sales / target - 1)}
              </td>
              <td class="text-end">${format.num(sales)}</td>
              <td class="text-end">${format.num(target)}</td>
            </tr>`).join("")}
        </tbody>
      </table>`,
  });
  tree.update({ rank: 5 });
  document.querySelector(".sales-slider").addEventListener("input", (e) => {
    tree.update({ rank: e.target.value });
  });
</script>
