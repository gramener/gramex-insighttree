<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="../insighttree.css" />
<link rel="stylesheet" href="../app/app.css" />

<input class="form-range sales-slider" type="range" min="0" max="15" value="5" />
<div class="sales-tree"></div>

<script type="module" class="script-source">
  import { insightTree } from "../index.js";
  const data = await fetch("sales-data.json").then((r) => r.json());

  import { scaleLinear } from "https://cdn.skypack.dev/d3-scale@4";
  const color = scaleLinear().domain([0.5, 1, 1.2]).range(["red", "yellow", "lime"]);

  import { pc, num } from "../app/format.js";

  const tree = insightTree(".sales-tree", {
    data: data,
    groups: ["city", "product", "channel"],
    metrics: ["sales", "target"],
    rankBy: ({ sales, target }) => sales - target,
    render: (el, tree) =>
      (el.innerHTML = /* html */ `
      <table class="table table-sm w-auto">
        <thead>
          <tr><th></th><th>Group</th><th>Gap</th><th>%</th><th>Sales</th><th>Target</th></tr>
        </thead>
        <tbody>
          ${tree
            .map(
              ({ _level, _rank, _group, sales, target }) => /* html */ `
            <tr data-insight-level="${_level}" data-insight-rank="${_rank}">
              <td class="text-end">#${_rank}</th>
              <td style="padding-left:${_level * 1.5}rem">
                <span class="insight-toggle"></span> ${_group}
              </td>
              <td class="text-end">${num.format(sales - target)}</td>
              <td class="text-end" style="background-color:${color(sales / target)}">
                ${pc.format(sales / target)}
              </td>
              <td class="text-end">${num.format(sales)}</td>
              <td class="text-end">${num.format(target)}</td>
            </tr>`
            )
            .join("")}
        </tbody>
      </table>`),
  });
  tree.update({ rank: 5 });
  document.querySelector(".sales-slider").addEventListener("input", (e) => {
    tree.update({ rank: e.target.value });
  });
</script>
